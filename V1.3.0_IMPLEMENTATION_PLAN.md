# خطة تنفيذ v1.3.0: نظام الملفات الشخصية والتحسينات

## 📋 نظرة عامة

هذه المرحلة تتضمن تطوير نظام كامل للملفات الشخصية مع تحديثات كبيرة على نموذج التسجيل وHeader. نظراً لحجم العمل الكبير، سيتم تقسيمه إلى مراحل صغيرة قابلة للتنفيذ.

---

## 🎯 الأهداف الرئيسية

1. **تحديث نموذج التسجيل** لدعم 3 أنواع من الحسابات
2. **تحديث Header** ليعرض اسم المستخدم وقائمة منسدلة
3. **إنشاء صفحات ملفات شخصية** لكل نوع مستخدم
4. **إنشاء لوحات تحكم** مخصصة لكل دور

---

## 📊 تقدير الوقت والجهد

| المرحلة | الوقت المتوقع | الصعوبة |
|---------|---------------|---------|
| تحديث نموذج التسجيل | 2-3 ساعات | متوسطة |
| تحديث Header | 1 ساعة | سهلة |
| صفحات الملفات الشخصية | 3-4 ساعات | متوسطة |
| لوحات التحكم | 4-5 ساعات | صعبة |
| **المجموع** | **10-13 ساعة** | **متوسطة-صعبة** |

---

## 🚀 المرحلة 1: تحديث نموذج التسجيل (2-3 ساعات)

### 1.1. تحديث `RegisterForm.tsx`

#### الحقول الجديدة المطلوبة:
```typescript
accountType: 'citizen' | 'mp' | 'candidate'  // نوع الحساب
councilId: number | null                      // المجلس (للنواب والمرشحين)
partyId: number | null                        // الحزب
isIndependent: boolean                        // مستقل؟
electoralSymbolId: number | null              // الرمز الانتخابي
electoralNumber: string                       // الرقم الانتخابي
district: string                              // الدائرة الانتخابية
committee: string                             // اللجنة (للنواب فقط)
```

#### التغييرات المطلوبة:
1. إضافة state للحقول الجديدة
2. إضافة useEffect لجلب councils, parties, symbols من Supabase
3. إضافة dropdown "نوع الحساب" في بداية النموذج
4. إضافة حقول conditional (تظهر فقط عند اختيار نائب أو مرشح)
5. تحديث validation
6. تحديث handleSubmit لإرسال البيانات الجديدة

### 1.2. تحديث `lib/auth.ts`

#### إضافة دالة جديدة:
```typescript
export async function signUpWithEmailAndProfile(data: {
  // البيانات الأساسية
  email: string;
  password: string;
  firstName: string;
  lastName: string;
  // ... باقي الحقول الحالية
  
  // البيانات الجديدة
  accountType: 'citizen' | 'mp' | 'candidate';
  councilId?: number;
  partyId?: number;
  isIndependent?: boolean;
  electoralSymbolId?: number;
  electoralNumber?: string;
  district?: string;
  committee?: string;
}) {
  // 1. إنشاء user في auth.users
  const { data: authData, error: authError } = await supabase.auth.signUp({
    email: data.email,
    password: data.password,
  });

  if (authError) return { user: null, error: authError.message };

  // 2. تحديد role_id حسب accountType
  let roleId = 3; // citizen
  if (data.accountType === 'mp') roleId = 4;
  if (data.accountType === 'candidate') roleId = 5;

  // 3. إنشاء user في users table
  const { data: userData, error: userError } = await supabase
    .from('users')
    .insert({
      auth_id: authData.user?.id,
      role_id: roleId,
      first_name: data.firstName,
      last_name: data.lastName,
      email: data.email,
      phone: data.phone,
      whatsapp: data.whatsapp,
      governorate_id: data.governorateId,
      city: data.city,
      village: data.village,
      dob: data.dob,
      gender: data.gender,
      job_title: data.jobTitle,
    })
    .select()
    .single();

  if (userError) return { user: null, error: userError.message };

  // 4. إذا كان نائب أو مرشح، إنشاء profile
  if (data.accountType !== 'citizen') {
    const { error: profileError } = await supabase
      .from('profiles')
      .insert({
        user_id: userData.id,
        council_id: data.councilId,
        party_id: data.partyId,
        is_independent: data.isIndependent || false,
        electoral_symbol_id: data.electoralSymbolId,
        electoral_number: data.electoralNumber,
        district: data.district,
        committee: data.committee,
      });

    if (profileError) return { user: null, error: profileError.message };
  }

  return { user: userData, error: null };
}
```

---

## 🚀 المرحلة 2: تحديث Header (1 ساعة)

### 2.1. إنشاء `components/auth/UserMenu.tsx`

```typescript
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ChevronDown, LogOut, LayoutDashboard } from 'lucide-react';
import { getUser, signOut } from '@/lib/auth';

export default function UserMenu() {
  const router = useRouter();
  const [user, setUser] = useState<any>(null);
  const [isOpen, setIsOpen] = useState(false);

  useEffect(() => {
    async function fetchUser() {
      const { user } = await getUser();
      setUser(user);
    }
    fetchUser();
  }, []);

  const handleSignOut = async () => {
    await signOut();
    router.push('/');
    router.refresh();
  };

  if (!user) return null;

  const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'المستخدم';

  return (
    <div className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-4 py-2 text-white hover:bg-[#005707] rounded-lg transition-colors"
      >
        <span>{fullName}</span>
        <ChevronDown className="w-4 h-4" />
      </button>

      {isOpen && (
        <div className="absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
          <Link
            href="/dashboard"
            className="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors"
            onClick={() => setIsOpen(false)}
          >
            <LayoutDashboard className="w-4 h-4" />
            <span>لوحة التحكم</span>
          </Link>

          <button
            onClick={handleSignOut}
            className="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 transition-colors w-full text-right"
          >
            <LogOut className="w-4 h-4" />
            <span>تسجيل الخروج</span>
          </button>
        </div>
      )}
    </div>
  );
}
```

### 2.2. تحديث `components/layout/Header.tsx`

```typescript
// في بداية الملف
import { getUser } from '@/lib/auth';
import UserMenu from '@/components/auth/UserMenu';

// داخل المكون
const [user, setUser] = useState<any>(null);

useEffect(() => {
  async function fetchUser() {
    const { user } = await getUser();
    setUser(user);
  }
  fetchUser();
}, []);

// في JSX، استبدال أزرار "تسجيل" و "دخول" بـ:
{user ? (
  <UserMenu />
) : (
  <div className="flex gap-2">
    <Link href="/register">
      <button className="px-4 py-2 border-2 border-[#004705] text-[#004705] rounded-lg hover:bg-[#004705] hover:text-white transition-colors">
        تسجيل
      </button>
    </Link>
    <Link href="/login">
      <button className="px-4 py-2 bg-[#004705] text-white rounded-lg hover:bg-[#005707] transition-colors">
        دخول
      </button>
    </Link>
  </div>
)}
```

---

## 🚀 المرحلة 3: صفحات الملفات الشخصية (3-4 ساعات)

### 3.1. صفحة المواطن: `app/citizen/[id]/page.tsx`

```typescript
import { getUserWithProfile } from '@/lib/supabase-queries';
import { notFound } from 'next/navigation';

export default async function CitizenProfilePage({ params }: { params: { id: string } }) {
  const user = await getUserWithProfile(params.id);

  if (!user) {
    notFound();
  }

  return (
    <div className="container mx-auto px-4 py-8">
      {/* Header */}
      <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div className="flex items-center gap-4">
          {user.avatar && (
            <img src={user.avatar} alt={`${user.first_name} ${user.last_name}`} className="w-24 h-24 rounded-full" />
          )}
          <div>
            <h1 className="text-3xl font-bold">{user.first_name} {user.last_name}</h1>
            <p className="text-gray-600">{user.city}, {user.governorate_id}</p>
            <p className="text-gray-600">{user.job_title}</p>
          </div>
        </div>
      </div>

      {/* الرسائل */}
      <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 className="text-2xl font-bold mb-4">الرسائل</h2>
        {/* قائمة الرسائل */}
      </div>

      {/* الشكاوى */}
      <div className="bg-white rounded-lg shadow-lg p-6">
        <h2 className="text-2xl font-bold mb-4">الشكاوى</h2>
        {/* قائمة الشكاوى */}
      </div>
    </div>
  );
}
```

### 3.2. صفحة النائب: `app/mp/[slug]/page.tsx`

```typescript
// مشابه لصفحة المواطن لكن مع إضافة:
// - معلومات المجلس
// - معلومات الحزب
// - الدائرة الانتخابية
// - الرمز الانتخابي
// - النقاط المكتسبة
// - المحتوى (إنجازات، فعاليات، برامج)
```

### 3.3. صفحة المرشح: `app/candidate/[slug]/page.tsx`

```typescript
// نفس صفحة النائب تقريباً
```

---

## 🚀 المرحلة 4: لوحات التحكم (4-5 ساعات)

### 4.1. لوحة تحكم المواطن: `app/dashboard/citizen/page.tsx`

```typescript
export default async function CitizenDashboard() {
  const { user } = await getUser();

  if (!user) {
    redirect('/login');
  }

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-6">لوحة تحكم المواطن</h1>

      {/* ملخص الإحصائيات */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div className="bg-white rounded-lg shadow-lg p-6">
          <h3 className="text-lg font-semibold mb-2">الرسائل</h3>
          <p className="text-3xl font-bold text-[#004705]">0</p>
        </div>

        <div className="bg-white rounded-lg shadow-lg p-6">
          <h3 className="text-lg font-semibold mb-2">الشكاوى</h3>
          <p className="text-3xl font-bold text-[#004705]">0</p>
        </div>

        <div className="bg-white rounded-lg shadow-lg p-6">
          <h3 className="text-lg font-semibold mb-2">الشكاوى المحلولة</h3>
          <p className="text-3xl font-bold text-green-600">0</p>
        </div>
      </div>

      {/* روابط سريعة */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Link href="/dashboard/citizen/messages" className="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
          <h3 className="text-xl font-semibold mb-2">إدارة الرسائل</h3>
          <p className="text-gray-600">إرسال واستقبال الرسائل</p>
        </Link>

        <Link href="/dashboard/citizen/complaints" className="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
          <h3 className="text-xl font-semibold mb-2">إدارة الشكاوى</h3>
          <p className="text-gray-600">تقديم ومتابعة الشكاوى</p>
        </Link>
      </div>
    </div>
  );
}
```

### 4.2. لوحة تحكم النائب: `app/dashboard/mp/page.tsx`

```typescript
// مشابه لكن مع إضافة:
// - الشكاوى المكلف بها
// - النقاط المكتسبة
// - إدارة المحتوى
// - إدارة البانر الشخصي
```

### 4.3. لوحة تحكم المرشح: `app/dashboard/candidate/page.tsx`

```typescript
// نفس لوحة النائب تقريباً
```

---

## 📝 الملفات المطلوب إنشاؤها/تعديلها

### ملفات جديدة (10 ملفات)
1. `lib/supabase-queries.ts` ✅ (تم)
2. `components/auth/UserMenu.tsx`
3. `app/citizen/[id]/page.tsx`
4. `app/mp/[slug]/page.tsx`
5. `app/candidate/[slug]/page.tsx`
6. `app/dashboard/citizen/page.tsx`
7. `app/dashboard/mp/page.tsx`
8. `app/dashboard/candidate/page.tsx`
9. `app/dashboard/citizen/messages/page.tsx`
10. `app/dashboard/citizen/complaints/page.tsx`

### ملفات تعديل (3 ملفات)
1. `components/auth/RegisterForm.tsx` - تحديث كبير
2. `components/layout/Header.tsx` - تحديث متوسط
3. `lib/auth.ts` - إضافة دالة جديدة

---

## ⚠️ التحديات المتوقعة

### 1. حجم العمل الكبير
- **المشكلة:** 13 ملف جديد/معدل
- **الحل:** تقسيم العمل إلى جلسات متعددة

### 2. تعقيد نموذج التسجيل
- **المشكلة:** حقول conditional معقدة
- **الحل:** استخدام state management جيد

### 3. جلب البيانات من Supabase
- **المشكلة:** queries متعددة ومعقدة
- **الحل:** استخدام `lib/supabase-queries.ts`

### 4. RLS Policies
- **المشكلة:** قد تمنع الوصول للبيانات
- **الحل:** التأكد من إعداد policies بشكل صحيح

---

## 🎯 التوصيات

### الخيار 1: التنفيذ الكامل (10-13 ساعة)
- تنفيذ جميع المراحل دفعة واحدة
- **المميزات:** نظام كامل ومتكامل
- **العيوب:** وقت طويل، احتمال أخطاء كثيرة

### الخيار 2: التنفيذ التدريجي (موصى به)
- **المرحلة 1:** تحديث نموذج التسجيل فقط (2-3 ساعات)
- **المرحلة 2:** تحديث Header (1 ساعة)
- **المرحلة 3:** صفحات الملفات الشخصية (3-4 ساعات)
- **المرحلة 4:** لوحات التحكم (4-5 ساعات)

**المميزات:**
- اختبار كل مرحلة قبل الانتقال للتالية
- تقليل الأخطاء
- إمكانية النشر التدريجي

**العيوب:**
- يحتاج عدة جلسات

### الخيار 3: MVP (الحد الأدنى) (4-5 ساعات)
- تحديث نموذج التسجيل (مبسط)
- تحديث Header
- صفحة ملف شخصي واحدة فقط
- لوحة تحكم بسيطة واحدة

---

## 🤔 ما هو الخيار الأفضل؟

**أوصي بالخيار 2 (التنفيذ التدريجي)** لأنه:
1. يضمن جودة الكود
2. يسهل الاختبار
3. يقلل الأخطاء
4. يمكن نشر كل مرحلة على حدة

---

## 📞 القرار التالي

**يرجى اختيار أحد الخيارات:**

1. **الخيار 1:** ابدأ التنفيذ الكامل الآن (10-13 ساعة)
2. **الخيار 2:** ابدأ بالمرحلة 1 فقط (تحديث نموذج التسجيل) (2-3 ساعات)
3. **الخيار 3:** ابدأ بـ MVP (الحد الأدنى) (4-5 ساعات)
4. **خيار آخر:** حدد ما تريده بالضبط

---

**تاريخ الإنشاء:** 2025-10-06  
**الإصدار المستهدف:** v1.3.0  
**الحالة:** ⏸️ في انتظار القرار
