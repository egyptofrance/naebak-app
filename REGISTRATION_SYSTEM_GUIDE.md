# دليل نظام التسجيل الجديد - منصة نائبك

## نظرة عامة

تم تطوير نظام تسجيل شامل جديد لمنصة نائبك باستخدام **Supabase Auth** يدعم ثلاثة أنواع من المستخدمين: المواطنين والمرشحين والنواب الحاليين.

## تدفق التسجيل

### 1. التسجيل الأولي
- المستخدم يدخل على صفحة الهبوط ويضغط على زر "تسجيل"
- يتم توجيهه لصفحة التسجيل `/auth/register`
- يطلب منه إدخال البريد الإلكتروني وكلمة المرور (مع التأكيد)
- النظام يتحقق تلقائياً من عدم وجود البريد الإلكتروني مسبقاً
- في حالة النجاح، يتم إرسال بريد إلكتروني للتحقق

### 2. تأكيد البريد الإلكتروني
- المستخدم يضغط على رابط التحقق في البريد الإلكتروني
- يتم توجيهه لصفحة `/auth/callback` للمعالجة
- بعد التحقق الناجح، يتم توجيهه لصفحة إعداد الحساب

### 3. تحديد نوع الحساب
- في صفحة `/auth/account-setup`، يختار المستخدم نوع حسابه:
  - **مواطن**: للمواطنين العاديين
  - **مرشح**: للمرشحين في الانتخابات
  - **نائب حالي**: لأعضاء مجلس النواب أو الشيوخ

### 4. إكمال الملف الشخصي
- في صفحة `/auth/profile-completion`، يكمل المستخدم بياناته:

#### للمواطنين:
- الاسم الأول والأخير
- رقم التليفون ورقم الواتساب (اختياري)
- المحافظة والمدينة والقرية (اختياري)
- الوظيفة والحزب
- الدائرة الانتخابية (اختياري)

#### للمرشحين والنواب:
- نفس البيانات السابقة بالإضافة إلى:
- الرمز الانتخابي (اختياري)
- الرقم الانتخابي (اختياري)

### 5. الوصول للوحة التحكم
- بعد إكمال الملف الشخصي، يتم توجيه المستخدم للوحة التحكم المناسبة
- كل نوع مستخدم له لوحة تحكم مخصصة

## الملفات الرئيسية

### صفحات المصادقة
```
app/auth/
├── register/page.tsx          # صفحة التسجيل
├── account-setup/page.tsx     # صفحة تحديد نوع الحساب
├── profile-completion/page.tsx # صفحة إكمال الملف الشخصي
└── callback/page.tsx          # معالجة تأكيد البريد الإلكتروني
```

### مكونات المصادقة
```
components/auth/
├── RegistrationForm.tsx       # نموذج التسجيل
├── AccountSetupForm.tsx       # نموذج تحديد نوع الحساب
└── ProfileCompletionForm.tsx  # نموذج إكمال الملف الشخصي
```

### لوحات التحكم
```
components/dashboards/
├── CitizenDashboard.tsx       # لوحة تحكم المواطن
├── CandidateDashboard.tsx     # لوحة تحكم المرشح
└── MPDashboard.tsx           # لوحة تحكم النائب
```

### المكتبات والتحقق
```
lib/
├── auth.ts                   # دوال المصادقة الرئيسية
└── validations/auth.ts       # schemas التحقق من البيانات
```

## الدوال الرئيسية

### `signUp(email, password, metadata)`
- إنشاء حساب جديد
- إرسال بريد التحقق
- معالجة الأخطاء المختلفة

### `signIn(email, password)`
- تسجيل الدخول
- التحقق من حالة الحساب
- توجيه المستخدم للصفحة المناسبة

### `setAccountType(accountType)`
- تحديد نوع الحساب في metadata
- دعم الأنواع: 'citizen', 'candidate', 'mp'

### `completeProfile(profileData)`
- حفظ بيانات الملف الشخصي
- تحديد حالة إكمال الملف الشخصي

### `getCurrentUser()`
- الحصول على بيانات المستخدم الحالي
- إرجاع null إذا لم يكن مسجل دخول

## Middleware Protection

يتحكم `middleware.ts` في تدفق التنقل:

### المسارات العامة
- `/` - الصفحة الرئيسية
- `/auth/login` - تسجيل الدخول
- `/auth/register` - التسجيل
- `/auth/callback` - معالجة التحقق

### المسارات المحمية
- `/dashboard` - لوحة التحكم
- `/auth/account-setup` - إعداد الحساب
- `/auth/profile-completion` - إكمال الملف الشخصي

### منطق الحماية
1. إذا لم يحدد المستخدم نوع حسابه → توجيه لـ `/auth/account-setup`
2. إذا لم يكمل ملفه الشخصي → توجيه لـ `/auth/profile-completion`
3. إذا كان مكتمل التسجيل ويحاول الوصول لصفحات المصادقة → توجيه لـ `/dashboard`

## التحقق من البيانات

### `registrationSchema`
- البريد الإلكتروني: صحيح ومطلوب
- كلمة المرور: 8 أحرف على الأقل، تحتوي على أحرف كبيرة وصغيرة وأرقام
- تأكيد كلمة المرور: يجب أن يطابق كلمة المرور

### `accountTypeSchema`
- نوع الحساب: يجب أن يكون أحد القيم المحددة

### `citizenProfileSchema` & `candidateProfileSchema`
- الاسم: عربي فقط، 2-50 حرف
- الهاتف: رقم مصري صحيح
- المحافظة والمدينة: مطلوبة
- الوظيفة والحزب: مطلوبة

## معالجة الأخطاء

### أخطاء التسجيل
- البريد الإلكتروني موجود مسبقاً
- كلمة مرور ضعيفة
- بريد إلكتروني غير صحيح
- تجاوز عدد المحاولات

### أخطاء تسجيل الدخول
- بيانات دخول خاطئة
- البريد الإلكتروني غير مؤكد
- تجاوز عدد المحاولات

## البيانات المحفوظة

### في `user_metadata`
```typescript
{
  account_type: 'citizen' | 'candidate' | 'mp',
  profile_completed: boolean,
  firstName: string,
  lastName: string,
  phone: string,
  whatsapp?: string,
  governorate: string,
  city: string,
  village?: string,
  job: string,
  party: string,
  constituency?: string,        // للمواطنين فقط
  electoralSymbol?: string,     // للمرشحين والنواب
  electoralNumber?: string,     // للمرشحين والنواب
  created_at: string,
  account_type_set_at?: string,
  profile_completed_at?: string
}
```

## الميزات المتقدمة

### مؤشر قوة كلمة المرور
- تقييم قوة كلمة المرور في الوقت الفعلي
- عرض مرئي للقوة (ضعيف → قوي جداً)

### التحقق التلقائي
- فحص تلقائي لوجود البريد الإلكتروني
- رسائل خطأ واضحة ومفصلة

### تجربة مستخدم محسنة
- تصميم responsive
- رسائل تأكيد واضحة
- مؤشرات تحميل
- انتقالات سلسة

## الاختبار

### سيناريوهات الاختبار
1. **تسجيل مستخدم جديد كمواطن**
2. **تسجيل مستخدم جديد كمرشح**
3. **تسجيل مستخدم جديد كنائب**
4. **محاولة التسجيل ببريد إلكتروني موجود**
5. **تسجيل دخول مستخدم لم يكمل إعداد حسابه**
6. **تسجيل دخول مستخدم لم يكمل ملفه الشخصي**

### نقاط التحقق
- ✅ إرسال بريد التحقق
- ✅ توجيه صحيح بعد التحقق
- ✅ حفظ نوع الحساب
- ✅ حفظ بيانات الملف الشخصي
- ✅ عرض لوحة التحكم المناسبة
- ✅ حماية المسارات

## الصيانة والتطوير

### إضافة نوع حساب جديد
1. تحديث `accountTypeSchema` في `validations/auth.ts`
2. إضافة النوع في `AccountSetupForm.tsx`
3. إنشاء لوحة تحكم جديدة
4. تحديث `dashboard/page.tsx`

### إضافة حقول جديدة للملف الشخصي
1. تحديث schemas في `validations/auth.ts`
2. تحديث `ProfileCompletionForm.tsx`
3. تحديث interfaces في الملفات ذات الصلة

### تخصيص رسائل الخطأ
- تحديث دوال المصادقة في `lib/auth.ts`
- إضافة رسائل جديدة في مكونات النماذج

---

**تاريخ الإنشاء**: 9 أكتوبر 2025  
**الإصدار**: 1.0  
**المطور**: egyptofrance
